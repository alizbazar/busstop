<!doctype html>
<html lang="en" manifest="manifest.appcache">
<head>
    <meta charset="UTF-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <meta http-equiv="cleartype" content="on">
    <title>Bussipysäkillä</title>
    <link rel="shortcut icon" sizes="196x196" href="icons/bus-196.png">
    <link rel="shortcut icon" href="icons/bus-196.png">

    <meta name="apple-touch-fullscreen" content="YES" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="HandheldFriendly" content="true" />
    <meta http-equiv="x-rim-auto-match" content="none" />
    <!-- This is to force IE into the latest version mode, overriding 'compatibility' mode which breaks everything. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="og:type" content="website" />
    <meta name="og:image" content="http://alizweb.s3.amazonaws.com/busstop/icons/bus-196.png?v=1"/>
    <meta name="og:title" content="Bussipysäkillä - Seuraa pysäkillesi saapuvia busseja" />
    <meta name="og:description" content="Seuraa reaaliajassa pysäkille saapuvia busseja, joissa on HELMI laite asennettuna" />
    <meta name="og:url" content="http://alizweb.s3.amazonaws.com/busstop/index.html"/>
    <meta property="fb:app_id" content="1427462937496382" />
    <meta property="fb:admins" content="706327167" />

    <!-- non-retina iPhone pre iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-57.png" sizes="57x57">
    <!-- non-retina iPad pre iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-72.png" sizes="72x72">
    <!-- non-retina iPad iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-76.png" sizes="76x76">
    <!-- retina iPhone pre iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-114.png" sizes="114x114">
    <!-- retina iPhone iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-120.png" sizes="120x120">
    <!-- retina iPad pre iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-144.png" sizes="144x144">
    <!-- retina iPad iOS 7 -->
    <link rel="apple-touch-icon" href="icons/bus-152.png" sizes="152x152">
    <!-- Win8 tile -->
    <meta name="msapplication-TileImage" content="bus-144.png">

    <!-- Tile icon for Win8 (144x144 + tile color) --> 
    <meta name="msapplication-TileImage" content="icons/bus-144.png">
    <meta name="msapplication-TileColor" content="#007ac9">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style>
    .container {
        text-align: center;
    }
    #schedule {
        text-align: left;
    }
    h2.timeLeft {
        font-size: 70px;
        padding-bottom: 20px;
        color: #3276B1;
    }
    h2.timeLeft.walk {
        color: #dbc625;
    }
    h2.timeLeft.run {
        color: #af3333;
    }
    .view h1:first-child, .view h2:first-child {
        margin-top: 0;
    }
    .jumbotron {
        margin-top: 10px;
    }
    #schedule tbody tr {
        cursor: pointer;
    }/*
    #schedule tbody tr:hover {
        background-color: #c7dced;
    }
    #schedule tbody td:hover {
        background-color: #c7dced;
    }*/
    .table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
        background-color: #e0f4ff;
    }
    #scheduleView .info-sub-text {
        margin-bottom: 4px;
        font-size: 15px;
    }

    #starStop {
        display: inline-block;
        width: 46px;
        height: 36px;
        margin-left: 10px;
        background: url('icons/star-icon-empty-36.png') no-repeat top left;
        margin-bottom: -4px;
    }

    #starStop.starred {
        background-image: url('icons/star-icon-36.png');
    }

    #starList {
        list-style-type: none;
        padding-left: 0;
    }

    #starList li {
        margin-top: 16px;
    }

    #sourceLink, .fb-like {
        display: inline;
    }

    @media screen and (max-width: 600px) {
        #sourceLink {
            display: none;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="jumbotron hidden view" id="indexView">
            <div class="firstUseView">
                <h1>Seuraa bussin saapumista pysäkille</h1>
                <p class="lead">Löydä bussipysäkki <a href="http://www.thoreb.se/webdeparture/HKL/358/main.asp" target="_blank">täältä</a>, kopioi pysäkkisivun osoite ja liitä ao. kenttään:</p>
            </div>
            <div id="withFavoritestView" class="hidden">
                <h2>Suosikkipysäkit</h2>
                <ul id="starList"></ul>
                <h2>Seuraa uutta pysäkkiä:</h2>
                <p>Hae pysäkkisivun osoite <a href="http://www.thoreb.se/webdeparture/HKL/358/main.asp" target="_blank">täältä</a></p>
            </div>
            <div class="form-group">
                <label for="pageUrl">Pysäkkisivun osoite:</label>
                <input type="url" id="pageUrl" class="form-control" value="" placeholder="http://www.thoreb.se/webdeparture/HKL/358/dep.asp?line=506&stopno=4074&stopname=Konemies@Maskinbyggaren&dir=2" />
            </div>
            <p><a href="#" class="btn btn-lg btn-primary" id="follow">Seuraa</a></p>
            <div class="firstUseView">
                <h4>Esimerkkipysäkkejä:</h4>
                <p><a href="http://www.thoreb.se/webdeparture/HKL/358/dep.asp?line=506&stopno=4043&stopname=Palkkatilanportti@L%F6nebost%E4llsporten&dir=2" class="btn btn-success quickLink" id="follow">Palkkatilanportti</a></p>
                <p><a href="http://www.thoreb.se/webdeparture/HKL/358/dep.asp?line=506&stopno=4074&stopname=Konemies@Maskinbyggaren&dir=2" class="btn btn-success quickLink" id="follow">Konemies</a></p>
            </div>
        </div>
        <div class="jumbotron view" id="scheduleView">
            <h2><span id="stopName"></span><a href="#" id="starStop"></a></h2>
            <p class="text-muted info-sub-text">Klikkaa bussia seurataksesi sen saapumista</p>
            <table id="schedule" class="table table-striped table-hover table-responsive tablesorter">
                <thead>
                    <tr>
                        <th>Määränpää</th>
                        <th>I.</th>
                        <th>II.</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p><a href="#" class="btn btn-lg btn-primary" id="backToIndex">Etusivulle</a></p>
        </div>
        <div class="jumbotron view hidden" id="timerView">
            <h2 class="busNo"></h2>
            <p class="lead">saapuu pysäkille</p>
            <h2 class="stopName"></h2>
            <h2 class="timeLeft"></h2>
            <p><a href="#" class="btn btn-lg btn-primary" id="backToSchedule">Aikatauluihin</a></p>
        </div>
        <div class="footer">
            <!--<div class="fb-like" data-href="http://alizweb.s3.amazonaws.com/busstop/index.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></div> | --><a href="http://www.twitter.com/alizbazar" target="_blank" class="text-muted">@alizbazar</a> 2014<div id="sourceLink"> | <a href="https://github.com/alizbazar/busstop" class="text-muted">Source</a></div>
        </div>
    </div>
    <!-- FB Like gives "suspicious URL" error for amazon url

    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=1427462937496382";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>-->

     <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
     <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.13.3/jquery.tablesorter.min.js"></script>
     <script>

     $('#schedule').tablesorter({sortList: [[1,0]]});

     var favorites = (function() {

        var save = function() {
            if (!JSON || !window.localStorage) {
                return false;
            }
            window.localStorage.setItem('busatstop', JSON.stringify(data));
            return true;
        };

        var controls = {
            add: function(stop, onlyDOM) {
                var stopDomItem = $('<li>').data('stopName', stop.name);
                $('<a>').attr('href', stop.url).addClass('quickLink btn btn-success').html(stop.name).appendTo(stopDomItem);
                $('#starList').append(stopDomItem);
                $('.firstUseView').toggleClass('hidden', true);
                $('#withFavoritestView').toggleClass('hidden', false);

                if (onlyDOM) {
                    return true;
                }
                data[stop.name] = stop.url;
                return save();
            },
            remove: function(stopName) {
                delete data[stopName];
                $('#starList').find('li').each(function(i, item) {
                    var $item = $(item);
                    if ($item.data('stopName') == stopName) {
                        $item.remove();
                        return false;
                    }
                });
                if (this.isEmpty()) {
                    $('#withFavoritestView').toggleClass('hidden', true);
                    $('.firstUseView').toggleClass('hidden', false);
                }
                return save();
            },
            has: function(stopName) {
                return !!data[stopName];
            },
            isEmpty: function() {
                return Object.keys(data).length == 0;
            }
        };

        // Init data table rightaway on loading
        var data = (function() {
            if (!JSON || !window.localStorage) {
                return {};
            }
            var retrieved = window.localStorage.getItem('busatstop');
            if (!!retrieved) {
                return JSON.parse(retrieved);
            }
            return {};
        }());

        if (!controls.isEmpty()) {
            $.each(data, function(name, url) {
                controls.add({"name": name, "url": url}, true);
            });
        }

        return controls;
     }());

     $('#follow').click(function(e) {
        var pageUrl = $('#pageUrl').val();
        if (!pageUrl) {
            pageUrl = $('#pageUrl').attr('placeholder');
        } else if (pageUrl.indexOf('http') != 0) {
            alert('Pysäkkisivun osoite -kentässä on oltava WWW-osoite');
            return;
        }

        // Because URL is fetched explicitly, clear possible timer
        if (timer) {
            clearTimeout(timer);
        }

        $('.view').not('#scheduleView').toggleClass('hidden', true);
        $('#scheduleView').toggleClass('hidden', false);
        renderSchedules(pageUrl);

        ga('send', 'event', 'mainInteractions', 'click', 'pageUrl', pageUrl);
        e.preventDefault();
     });

     function parseUrl(url) {

        return {pageUrl: url};
     }

     var timer = null;
     var currentStop = {};
     function renderSchedules(pageUrl) {
        var scheduleView = $('#scheduleView');
        if (pageUrl) {
            var pageData = parseUrl(pageUrl);
        } else {
            var pageData = scheduleView.data('pageData');
        }
        // TODO: validate pagedata
        if (pageUrl) {
            window.location.hash = pageUrl;
        }
        scheduleView.data('pageData', pageData);
        $.ajax({
            url: "http://tools.alizweb.com/busatstop/getData.php",
            dataType: "jsonp",
            data: pageData,
            success: function(response) {
                var data = response.data;
                // Render view
                timerWatch.updateData(data);
                timer = setTimeout(renderSchedules, 15000);

                if ($('#scheduleView').hasClass('hidden')) {
                    return;
                }

                $('#stopName').html(data.stopname);
                $('#starStop').toggleClass('starred', favorites.has(data.stopname));
                currentStop = {"name": data.stopname, "url": pageUrl};
                var tbody = $('#schedule tbody');
                tbody.empty();
                $.each(data.lines, function(i, line) {
                    var tr = $('<tr>').data('destination', line.destination);
                    $('<td>').addClass('destination').html(line.destination).appendTo(tr);
                    $('<td>').addClass('timeEstimate').text(line.timeEstimate).appendTo(tr);
                    $('<td>').addClass('nextTimeEstimate').text(line.nextTimeEstimate).appendTo(tr);
                    tr.appendTo(tbody);
                });
                
                $('#schedule').trigger('update');
            },
            error: function() {
                $('#scheduleView').toggleClass('hidden', true);
                $('#indexView').toggleClass('hidden', false);
            }
        });
     }

     $('#starStop').click(function(e) {
        $star = $(this);
        // get current stop
        if (!currentStop) {
            return false;
        }

        if (favorites.has(currentStop.name)) {
            favorites.remove(currentStop.name);
            $star.toggleClass('starred', false);
        } else {
            favorites.add(currentStop);
            $star.toggleClass('starred', true);

        }
        // check if it's starred
        // unstar / star to localstorage
        // change star state
        // change frontpage view state
        e.preventDefault();
     });

     $('#schedule tbody').on('click', function(e) {
        var destination = $(e.target).closest('tr').data('destination');
        if (destination)
            timerWatch.init(destination);
     });

     $('#backToIndex').click(function() {
        clearTimeout(timer);
        $('.view').not('#indexView').toggleClass('hidden', true);
        $('#indexView').toggleClass('hidden', false);
     });

     $('#backToSchedule').click(function(e) {
        $('.view').not('#scheduleView').toggleClass('hidden', true);
        $('#scheduleView').toggleClass('hidden', false);
        e.preventDefault();
     });

     $('#indexView').on('click', 'a.quickLink', function(e) {
        var url = $(this).attr('href');
        renderSchedules(url);
        $('.view').not('#scheduleView').toggleClass('hidden', true);
        $('#scheduleView').toggleClass('hidden', false);
        e.preventDefault();
     });

     var timerWatch = (function() {
        var data, destination;
        var $view = $('#timerView');
        var lastTimeLeft;

        var timeTable = {};

        function updateTimer(minutesLeft) {
            lastTimeLeft = minutesLeft;
            if (minutesLeft.indexOf('~') == 0) {
                minutesLeft = minutesLeft.substring(1);
            }
            minutesLeft = parseInt(minutesLeft, 10);

            var $timer = $view.find('.timeLeft');
            if (minutesLeft < 4) {
                $timer.toggleClass('run', true).toggleClass('walk', false);
            } else if (minutesLeft < 7) {
                $timer.toggleClass('walk', true).toggleClass('run', false);
            } else {
                $timer.toggleClass('run', false).toggleClass('walk', false);
            }

            var time = new Date().getTime();
            time += minutesLeft * 60 * 1000;
            if ($timer.hasClass('hasCountdown')) {
                $timer.countdown('option', 'until', new Date(time));
            } else {
                $timer.countdown({compact: true, format: 'MS', padZeroes: true, until: new Date(time)});
            }
        };

        return {
            'init': function(dest, latestData) {
                if (latestData) {
                    data = latestData;
                }
                if (!data) {
                    return;
                }
                destination = dest;
                $view.find('.busNo').html(destination);
                $view.find('.stopName').html(data.stopname);
                $('.view').not($view).toggleClass('hidden', true);
                $view.toggleClass('hidden', false);
                this.updateData(data);
            },
            'updateData': function(latestData) {
                data = latestData;
                if (!destination || $view.hasClass('hidden')) {
                    return;
                }
                var newTimeLeft;
                $.each(data.lines, function(i, line) {
                    if (line.destination == destination) {
                        newTimeLeft = line.timeEstimate;
                        return false;
                    }
                });
                if (newTimeLeft != lastTimeLeft) {
                    updateTimer(newTimeLeft);
                }
            }
        }
     }());

     var hash = window.location.hash;
     if (hash && hash.length > 1) {
        var url = hash.substring(1);
        renderSchedules(url);
     } else {
        $('.view').not('#indexView').toggleClass('hidden', true);
        $('#indexView').toggleClass('hidden', false);
     }
     </script>
     <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-countdown/1.6.3/jquery.countdown.min.js"></script>

     <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-48496117-1', 'alizweb.s3.amazonaws.com');
      ga('send', 'pageview');

    </script>
</body>
</html>